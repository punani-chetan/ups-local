<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>UPS</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous" />
  <link rel="stylesheet" type="text/css" href="style.css" />
  <!-- Option 1: Include in HTML -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.3.0/font/bootstrap-icons.css" />
</head>

<body>
  <div class="container-fluid h-100">
    <div class="row justify-content-center h-100">
      <div class="col">
        <div class="h-100 d-flex flex-column">
          <div class="row justify-content-center">
            <nav class="navbar">
              <div class="w-100">
                <div class="mx-5 text-white d-flex flex-row">
                  <h3><b>HITACHI</b></h3>
                  <div class="d-flex justify-content-center align-items-center w-100">
                    <span class="mx-4"><a href="index.html" class="header-main-menu">Home</a></span>
                    <span class="mx-4 active-tab-border"><a href="configuration.html"
                        class="header-main-menu">Configuration</a></span>
                    <span class="mx-4"><a href="https://www.hitachi-hirel.com/contact-us"
                        class="header-main-menu">Contact</a></span>
                  </div>
                </div>
              </div>
            </nav>
          </div>
          <div class="row justify-content-center flex-grow-1 main-bgcolor">

            <!-- spinner with overlay -->
            <div class="overlay">
              <div class="overlay__content">
                <span class="spinner"></span>
              </div>
            </div>
            <!-- spinner with overlay -->

            <div class="w-100">
              <div class="mt-5">
                <div class="d-flex justify-content-center">
                  <div class="card mx-3" style="width: 50%">
                    <div class="card-body">
                      <h5 class="card-title text-center">
                        Data Logging Interval
                      </h5>
                      <form id="setIntervalForm" class="mt-3 needs-validation" novalidate>
                        <div class="form-group">
                          <input type="text" value="1" class="form-control" id="textDataLoggingInterval"
                            aria-describedby="textDataLoggingInterval"
                            placeholder="Enter Data Logging Interval (Minute)" required pattern="[0-9]+" />
                          <small id="textDataLoggingInterval" class="form-text text-muted">Note: Enter Interval in
                            Minute.</small>
                          <div class="invalid-feedback">
                            Please provide a valid Data Logging Interval in
                            Minutes.
                          </div>
                        </div>

                        <div class="row mt-3 mx-auto">
                          <div class="col-6">
                            <button type="submit" class="btn btn-primary">
                              Set Interval
                            </button>
                          </div>
                          <div class="col-6">
                            <button type="button" class="btn btn-secondary" onclick="resetIntervalForm()">
                              Reset Interval
                            </button>
                          </div>
                        </div>
                      </form>
                    </div>
                  </div>

                  <div class="card mx-3" style="width: 50%">
                    <div class="card-body">
                      <h5 class="card-title text-center">SNMP TRAP IP</h5>

                      <form id="setSnmpTrapIPForm" class="mt-3 needs-validation" novalidate>
                        <div class="form-group">
                          <input type="text" value="255.255.255.255" class="form-control" id="textSnmpTrapIp"
                            aria-describedby="textSnmpTrapIp" placeholder="Enter SNMP TRAP IP" required
                            pattern="^((25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$" />
                          <div class="invalid-feedback">
                            Please provide a valid SNMP TRAP IP.
                          </div>
                        </div>

                        <div class="row mt-3 mx-auto">
                          <div class="col-6">
                            <button type="submit" class="btn btn-primary">
                              Set TRAP IP
                            </button>
                          </div>
                          <div class="col-6">
                            <button type="button" class="btn btn-secondary" onclick="resetTrapIPForm()">
                              Reset TRAP IP
                            </button>
                          </div>
                        </div>
                      </form>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script type="text/javascript" src="./ups.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4"
    crossorigin="anonymous"></script>

  <script>
    (function () {
      "use strict";

      // Fetch all the forms we want to apply custom Bootstrap validation styles to
      var forms = document.querySelectorAll(".needs-validation");

      // Loop over them and prevent submission
      Array.prototype.slice.call(forms).forEach(function (form) {
        form.addEventListener(
          "submit",
          function (event) {
            if (!form.checkValidity()) {
              event.preventDefault();
              event.stopPropagation();
            }

            form.classList.add("was-validated");
          },
          false
        );
      });
    })();

    var url = 'ws://ups-gateway/ws';
    // var url = 'ws://localhost:8080';
    var configurationWS = new WebSocket(url);
    var deviceId;
    var callOnce = true;

    configurationWS.onopen = function () {
      configurationWS.send('Status WS Started');
      console.log("Web socket is connected");
    };

    configurationWS.onmessage = async function (evt) {

      var ups_data = await UPS_MSG(evt.data);
      deviceId = ups_data.dev_id;

      if (ups_data) {
        document.getElementsByClassName('overlay')[0].classList.add('d-none')
      }

      if (callOnce) {
        callOnce = false;
        if (deviceId) {
          let obj = {};
          obj.msg_id = 8;
          obj.dev_id = deviceId;
          let jsonString = JSON.stringify(obj);
          configurationWS.send(jsonString);
        }
      }

      if (ups_data.DATA_NAME == 'configuration') {

        let configData = ups_data.configData;

        document.getElementById('textDataLoggingInterval').value = configData.Data_LOGtime;
        document.getElementById('textSnmpTrapIp').value = configData.Dest_Trapip;
      }

    }

    var IntervalForm = document.getElementById("setIntervalForm");
    IntervalForm.addEventListener("submit", SetIntervalFunction);

    var SnmpTrapIpForm = document.getElementById("setSnmpTrapIPForm");
    SnmpTrapIpForm.addEventListener("submit", SetSnmpTrapIpFunction);

    function resetIntervalForm() {
      document.getElementById("setIntervalForm").reset();
    }

    function resetTrapIPForm() {
      document.getElementById("setSnmpTrapIPForm").reset();
    }

    function SetIntervalFunction(event) {
      console.log('here on submit')
      event.preventDefault();
      var formData = new FormData(event.target);
      console.log(
        "Data Logging Interval : ",
        document.getElementById("textDataLoggingInterval").value
      );

      console.log(deviceId)
      if (deviceId) {
        let objInterval = {
          msg_id: 6,
          dev_id: deviceId,
          properties: {
            log_interval: +document.getElementById("textDataLoggingInterval").value
          }
        };

        let jsonString = JSON.stringify(objInterval);
        console.log(jsonString)
        configurationWS.send(jsonString);
      }
    }

    function SetSnmpTrapIpFunction(event) {
      event.preventDefault();
      var formData = new FormData(event.target);
      console.log(
        "SNMP TRAP IP : ",
        document.getElementById("textSnmpTrapIp").value
      );

      if (deviceId) {
        let objInterval = {
          msg_id: 5,
          dev_id: deviceId,
          properties: {
            strap_ip: document.getElementById("textSnmpTrapIp").value
          }
        };

        let jsonString = JSON.stringify(objInterval);
        console.log(jsonString)
        configurationWS.send(jsonString);
      }
    }

    // }
  </script>
</body>

</html>